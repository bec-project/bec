#!/bin/bash

# NOTE: pip 23.0 (2023-01-30) fixes a bug that would display the wrong path for editable installs
# https://pip.pypa.io/en/stable/news/#id115
# it doesn't seem to be an issue without pyproject.toml
editable_path=$(pip show bec-ipython-client | grep "Editable project location" | cut -d' ' -f4)

if [ -n "$editable_path" ]; then
    BEC_CLIENT_PATH=$editable_path
else
    BEC_CLIENT_PATH=$(pip show bec-ipython-client | grep "Location" | cut -d' ' -f2)
fi

STARTUP_SCRIPT=$BEC_CLIENT_PATH/bec_client/bin/bec_startup.py

# --version flag
if [[ $1 == "--version" ]]; then
    # Get the version of the installed python package
    # if its installed in editable mode, get the version from the setup.py file
    # this can be done by checking if the path contains the string "/site-packages/"
    if [[ $BEC_CLIENT_PATH == *"/site-packages"* ]]; then
        version=$(pip show bec-ipython-client | grep "Version" | cut -d' ' -f2)
    else
        version=$(cat $BEC_CLIENT_PATH/setup.py | grep "__version__ =" | cut -d'=' -f2 | tr -d "'" | tr -d " ")
    fi
    echo "BEC IPython client: $version"
    exit 0
fi

# Run the startup script and pass on any arguments
ipython -i $STARTUP_SCRIPT -- $@
